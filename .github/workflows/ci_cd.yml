name: dbt CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

jobs:
  lint:
    name: Lint SQL with sqlfluff
    runs-on: ubuntu-latest
    env:
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install sqlfluff sqlfluff-templater-dbt dbt-snowflake==1.10.3

      - name: Create profiles.yml for dbt compilation
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          gg_vp_data:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                schema: staging
                threads: 4
          EOF

      - name: Install dbt packages
        run: dbt deps

      - name: Run sqlfluff lint
        run: |
          sqlfluff lint models/ --dialect snowflake

  test-dev:
    name: Test on DEV environment
    runs-on: ubuntu-latest
    needs: lint
    env:
      DBT_TARGET: dev
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake==1.10.3

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          gg_vp_data:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                schema: staging
                threads: 4
          EOF

      - name: dbt deps
        run: dbt deps

      - name: dbt debug
        run: dbt debug

      - name: Detect changes in dbt files
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
          fi

          # Check if this is the first commit on the branch
          if [ "$BASE_REF" == "0000000000000000000000000000000000000000" ] || [ -z "$BASE_REF" ]; then
            echo "First commit detected, forcing full refresh"
            echo "needs_full_refresh=true" >> $GITHUB_OUTPUT
          else
            # Detect changes in dbt-related files
            CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD || echo "error")

            if echo "$CHANGED_FILES" | grep -qE '^(models/|seeds/|macros/|dbt_project\.yml)'; then
              echo "Changes detected in dbt files, full refresh needed"
              echo "needs_full_refresh=true" >> $GITHUB_OUTPUT
            else
              echo "No changes in dbt files, incremental run"
              echo "needs_full_refresh=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: dbt seed
        run: dbt seed --target dev

      - name: dbt run (full-refresh)
        if: steps.changes.outputs.needs_full_refresh == 'true'
        run: dbt run --target dev --full-refresh

      - name: dbt run (incremental)
        if: steps.changes.outputs.needs_full_refresh == 'false'
        run: dbt run --target dev

      - name: dbt test
        run: dbt test --target dev

  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: test-dev
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    env:
      DBT_TARGET: dev
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake==1.10.3

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          gg_vp_data:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE_DEV }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                schema: staging
                threads: 4
          EOF

      - name: Run Flyway migrations (DEV)
        uses: docker://flyway/flyway:latest
        env:
          JAVA_TOOL_OPTIONS: "--add-opens=java.base/java.nio=org.apache.arrow.memory.core,ALL-UNNAMED"
        with:
          args: >
            -url=jdbc:snowflake://${{ secrets.SNOWFLAKE_ACCOUNT }}.snowflakecomputing.com/?db=${{ secrets.SNOWFLAKE_DATABASE_DEV }}&schema=staging&role=${{ secrets.SNOWFLAKE_ROLE }}&warehouse=${{ secrets.SNOWFLAKE_WAREHOUSE }}
            -user=${{ secrets.SNOWFLAKE_USER }}
            -password=${{ secrets.SNOWFLAKE_PASSWORD }}
            -locations=filesystem:./flyway/sql
            -schemas=staging,intermediate,marts
            migrate

      - name: dbt deps
        run: dbt deps

      - name: Detect changes in dbt files
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
          fi

          # Check if this is the first commit on the branch
          if [ "$BASE_REF" == "0000000000000000000000000000000000000000" ] || [ -z "$BASE_REF" ]; then
            echo "First commit detected, forcing full refresh"
            echo "needs_full_refresh=true" >> $GITHUB_OUTPUT
          else
            # Detect changes in dbt-related files
            CHANGED_FILES=$(git diff --name-only $BASE_REF HEAD || echo "error")

            if echo "$CHANGED_FILES" | grep -qE '^(models/|seeds/|macros/|dbt_project\.yml)'; then
              echo "Changes detected in dbt files, full refresh needed"
              echo "needs_full_refresh=true" >> $GITHUB_OUTPUT
            else
              echo "No changes in dbt files, incremental run"
              echo "needs_full_refresh=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: dbt seed
        run: dbt seed --target dev

      - name: dbt run (full-refresh)
        if: steps.changes.outputs.needs_full_refresh == 'true'
        run: dbt run --target dev --full-refresh

      - name: dbt run (incremental)
        if: steps.changes.outputs.needs_full_refresh == 'false'
        run: dbt run --target dev

      - name: dbt test
        run: dbt test --target dev

      - name: Generate dbt docs
        run: |
          dbt docs generate --target dev

      - name: Notify deployment
        if: success()
        run: |
          echo "✅ DEV deployment successful"

  deploy-prod:
    name: Deploy to PROD (Manual Approval Required)
    runs-on: ubuntu-latest
    needs: test-dev
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://app.snowflake.com
    env:
      DBT_TARGET: prod
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE_PROD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake==1.10.3

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<EOF
          gg_vp_data:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE_PROD }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                schema: staging
                threads: 4
          EOF

      - name: Run Flyway migrations (PROD)
        uses: docker://flyway/flyway:latest
        env:
          JAVA_TOOL_OPTIONS: "--add-opens=java.base/java.nio=org.apache.arrow.memory.core,ALL-UNNAMED"
        with:
          args: >
            -url=jdbc:snowflake://${{ secrets.SNOWFLAKE_ACCOUNT }}.snowflakecomputing.com/?db=${{ secrets.SNOWFLAKE_DATABASE_PROD }}&schema=staging&role=${{ secrets.SNOWFLAKE_ROLE }}&warehouse=${{ secrets.SNOWFLAKE_WAREHOUSE }}
            -user=${{ secrets.SNOWFLAKE_USER }}
            -password=${{ secrets.SNOWFLAKE_PASSWORD }}
            -locations=filesystem:./flyway/sql
            -schemas=staging,intermediate,marts
            migrate

      - name: dbt deps
        run: dbt deps

      - name: dbt run (incremental)
        run: dbt run --target prod

      - name: dbt test (fail-fast)
        run: dbt test --target prod --fail-fast

      - name: Generate dbt docs
        run: |
          dbt docs generate --target prod

      - name: Create deployment tag
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "deploy-$(date +%Y%m%d-%H%M%S)" -m "Production deployment"
          git push origin --tags

      - name: Notify deployment success
        if: success()
        run: |
          echo "✅ PROD deployment successful at $(date)"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "❌ PROD deployment failed - manual rollback required"
          echo "Check logs and run: dbt run --target prod --vars '{rollback: true}'"
          exit 1
